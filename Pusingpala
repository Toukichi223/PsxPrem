-- [ A. INISIALISASI DAN KONFIGURASI ]
local p = game:GetService("Players").LocalPlayer 
-- Kita bisa langsung menggunakan p.PlayerGui karena skrip ini akan dieksekusi di sana
local gui_target = p:WaitForChild("PlayerGui") -- Gunakan WaitForChild untuk keamanan
local rs = game:GetService("RunService")
local Debris = game:GetService("Debris") -- Tambahkan Service Debris
local TweenService = game:GetService("TweenService") -- Tambahkan Service TweenService

-- KONFIGURASI INTI
local DEFAULT_WALKSPEED = 16
local MAIN_COLOR = Color3.fromRGB(0, 255, 255) 
local FAKE_RESPAWN_DELAY = 0.3 

-- Variabel Status
local tp_pos = nil 
local is_stealth_mode = false 

-- Deklarasi tombol untuk sinkronisasi
local phys_btn = nil 

-- [ B. FUNGSI UTILITY & SAFETY ]

local function get_fresh_parts()
    -- Cek karakter agar tidak nil sebelum mencoba mengakses
    local current_char = p.Character or p.CharacterAdded:Wait() 
    if not current_char then return nil, nil, nil end
    local current_h = current_char:FindFirstChildOfClass("Humanoid")
    local current_hrp = current_char:FindFirstChild("HumanoidRootPart")
    if not current_h or not current_hrp then return nil, nil, nil end
    return current_h, current_hrp, current_char 
end

-- FUNGSI BARU: NOTIFIKASI POP-UP DI LAYAR
local function show_notification(message, color)
    if not gui_target then return end
    
    local notif_frame = Instance.new("Frame")
    notif_frame.Size = UDim2.new(0, 200, 0, 30)
    notif_frame.Position = UDim2.new(0, 10, 0.95, 40) -- Posisi awal agak di luar
    notif_frame.BackgroundColor3 = color or MAIN_COLOR
    notif_frame.BackgroundTransparency = 0.2
    notif_frame.BorderSizePixel = 0
    notif_frame.Parent = gui_target
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Text = message
    label.Font = Enum.Font.SourceSansBold
    label.TextSize = 14
    label.Parent = notif_frame
    
    -- Efek slide in
    local info = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local goal = {Position = UDim2.new(0, 10, 0.95, -40)}
    TweenService:Create(notif_frame, info, goal):Play()
    
    -- Efek fade out dan hapus setelah 3 detik
    Debris:AddItem(notif_frame, 3) 
end

-- Deklarasi fungsi utama
local execute_stealth_tp 
local toggle_stealth_mode
local save_tp

-- [ C. FUNGSI UTAMA LOGIKA ]

-- FUNGSI SAVE TP
save_tp = function(btn)
    local _, hrp_current = get_fresh_parts()
    if hrp_current then
        tp_pos = hrp_current.CFrame 
        btn.Text = "SAVED"
        show_notification("Base Position SAVED!", Color3.fromRGB(0, 255, 0))
    else
        warn("TP GAGAL: Karakter tidak siap!")
        show_notification("SAVE GAGAL!", Color3.fromRGB(255, 0, 0))
    end
end

-- FUNGSI TOGGLE STEALTH MODE (WalkSpeed Block & NoClip)
toggle_stealth_mode = function(btn)
    local h, hrp, char = get_fresh_parts()
    if not hrp or not char then 
        warn("STEALTH MODE GAGAL: Tidak ada HRP/Karakter.")
        show_notification("STEALTH GAGAL!", Color3.fromRGB(255, 0, 0))
        return 
    end
    
    is_stealth_mode = not is_stealth_mode
    
    if is_stealth_mode then
        btn.Text = "STEALTH ON"
        
        -- Memblokir pergerakan tanpa menghapus Humanoid
        if h then 
            h.WalkSpeed = 0 
            h.PlatformStand = true
        end
        
        -- Aktifkan NoClip Mutlak
        hrp.CanCollide = false 
        show_notification("STEALTH MODE: ON (Ready to Grab)", MAIN_COLOR)
        
    else
        btn.Text = "PHYS OFF"
        
        -- Pulihkan Pergerakan
        if h then
            h.WalkSpeed = DEFAULT_WALKSPEED
            h.PlatformStand = false
        end
        
        -- Pulihkan Fisika
        hrp.CanCollide = true 
        show_notification("STEALTH MODE: OFF (Sync)", Color3.fromRGB(255, 255, 0))
    end
end

-- FUNGSI EXECUTE STEALTH TP (Fake Death Reborn)
execute_stealth_tp = function()
    local h_current, hrp, char = get_fresh_parts()
    
    if not hrp or not tp_pos or not char or not is_stealth_mode then 
        warn("STEALTH TP GAGAL: Cek SAVE dan STEALTH ON.")
        show_notification("GO! GAGAL (Need Setup)", Color3.fromRGB(255, 0, 0))
        return 
    end
    
    if not h_current then
        warn("STEALTH TP GAGAL: Humanoid tidak ditemukan.")
        show_notification("GO! GAGAL (Humanoid Missing)", Color3.fromRGB(255, 0, 0))
        return
    end

    show_notification("GO! Running Fake Death...", MAIN_COLOR)
    
    -- 1. FAKE DEATH
    h_current:ChangeState(Enum.HumanoidStateType.Dead)
    
    -- 2. JEDA MIKRO
    task.wait(FAKE_RESPAWN_DELAY) -- Ganti wait() ke task.wait() (modern)
    
    -- 3. TELEPORTASI
    char:SetPrimaryPartCFrame(tp_pos)
    
    -- 4. Sinkronisasi Penuh (Matikan STEALTH MODE)
    if phys_btn and is_stealth_mode then
        toggle_stealth_mode(phys_btn)
    end
    
    show_notification("TELEPORT SUCCESS! (Item Aman)", Color3.fromRGB(0, 255, 0))
end

-- [ D. IMPLEMENTASI GUI (PERMANEN - V25) ]

-- Tunggu PlayerGui muncul
local sg = Instance.new("ScreenGui")
sg.Name = ("StealthHub_V25") 
sg.ResetOnSpawn = false
sg.Parent = gui_target

local action_bar = Instance.new("Frame")
action_bar.Name = "action_bar"
action_bar.Size = UDim2.new(0, 60, 0, 150)
action_bar.Position = UDim2.new(0, 10, 0.4, 0)
action_bar.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
action_bar.BorderColor3 = MAIN_COLOR
action_bar.BorderSizePixel = 1
action_bar.Parent = sg
action_bar.ZIndex = 100 
action_bar.Visible = true 
action_bar.Active = true 
action_bar.Draggable = true 

-- Layout Vertikal
local layout = Instance.new("UIListLayout")
layout.FillDirection = Enum.FillDirection.Vertical
layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
layout.Padding = UDim.new(0, 5)
layout.Parent = action_bar

-- FUNGSI TOMBOL DI ACTION BAR
local function create_bar_button(name, callback)
    local btn = Instance.new("TextButton")
    btn.Name = name:gsub("%s+", ""):lower() .. "_btn" 
    btn.Size = UDim2.new(1, 0, 0, 45)
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    btn.TextColor3 = MAIN_COLOR
    btn.BorderSizePixel = 0
    btn.Parent = action_bar
    
    btn.MouseButton1Click:Connect(function()
        -- Pastikan tombol "SAVE" dan "PHYS OFF"/"STEALTH ON" meneruskan objek tombol
        if btn.Name == "save_btn" or btn.Name == "physoff_btn" or btn.Name == "stealthon_btn" then
            callback(btn)
        else
            callback()
        end
    end) 
    
    return btn
end

-- PENEMPATAN TOMBOL (Vertikal)
local save_btn = create_bar_button("SAVE", save_tp)
phys_btn = create_bar_button("PHYS OFF", toggle_stealth_mode) -- Assign ke variabel global yang dideklarasikan di awal
phys_btn.Name = "phys_btn" 
local go_btn = create_bar_button("GO!", execute_stealth_tp)


-- Pastikan karakter sudah dimuat saat pertama kali skrip berjalan
if not p.Character then
    p.CharacterAdded:Wait()
end
