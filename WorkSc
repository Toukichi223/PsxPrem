-- [ A. INISIALISASI DAN KONFIGURASI ]
local p = game:GetService("Players").LocalPlayer 
local gui_target = p.PlayerGui 
local rs = game:GetService("RunService")

-- KONFIGURASI INTI
local DEFAULT_WALKSPEED = 16
local MAIN_COLOR = Color3.fromRGB(0, 255, 255) 

-- Variabel Status
local tp_pos = nil 
local is_stealth_mode = false 

-- [ B. FUNGSI UTILITY & SAFETY ]

local function get_fresh_parts()
    local current_char = p.Character
    if not current_char then return nil, nil, nil end
    local current_h = current_char:FindFirstChildOfClass("Humanoid")
    local current_hrp = current_char:FindFirstChild("HumanoidRootPart")
    if not current_h or not current_hrp then return nil, nil, nil end
    return current_h, current_hrp, current_char 
end

-- Deklarasi fungsi utama
local execute_iigr_tp 
local toggle_stealth_mode
local save_tp

-- [ C. FUNGSI UTAMA LOGIKA ]

-- FUNGSI SAVE TP
save_tp = function(btn)
    local _, hrp_current = get_fresh_parts()
    if hrp_current then
        tp_pos = hrp_current.CFrame 
        btn.Text = "SAVED"
        warn("TP: Posisi Base Tersimpan!")
    else
        warn("TP GAGAL: Karakter tidak siap!")
    end
end

-- FUNGSI TOGGLE STEALTH MODE (Untuk Base Lock Bypass)
toggle_stealth_mode = function(btn)
    local h, hrp, char = get_fresh_parts()
    if not hrp or not char then 
        warn("STEALTH MODE GAGAL: Tidak ada HRP/Karakter.")
        return 
    end
    
    is_stealth_mode = not is_stealth_mode
    
    if is_stealth_mode then
        btn.Text = "STEALTH ON"
        warn("STEALTH MODE AKTIF: Siap mengambil item (NoClip aktif).")
        
        -- Hapus Humanoid agar tidak merespon gerakan
        if h then h:Destroy() end
        
        -- Aktifkan NoClip Mutlak
        hrp.CanCollide = false 
        
    else
        btn.Text = "PHYS OFF"
        warn("SINKRONISASI: Mencoba memulihkan karakter dan Humanoid.")
        
        -- Pulihkan Humanoid (wajib)
        if not char:FindFirstChildOfClass("Humanoid") then
            local new_h = Instance.new("Humanoid")
            new_h.Parent = char
            new_h.WalkSpeed = DEFAULT_WALKSPEED
        end
        
        -- Pulihkan Fisika
        hrp.CanCollide = true 
    end
end

-- FUNGSI EXECUTE IIGR TP (Zero-Lag Kematian & Balapan Respawn)
execute_iigr_tp = function()
    local h_current, hrp, char = get_fresh_parts()
    
    if not hrp or not tp_pos or not char then 
        warn("IIGR TP GAGAL: Posisi Base atau HRP tidak siap!")
        return 
    end
    
    if not is_stealth_mode then
        warn("IIGR TP GAGAL: Aktifkan MODE STEALTH (STEALTH ON) dulu!")
        return
    end

    warn("IIGR TP: Memulai Balapan Zero-Lag...")
    
    -- 1. Pulihkan Humanoid untuk memicu Kematian
    if not h_current then
        h_current = Instance.new("Humanoid")
        h_current.Parent = char
        h_current.WalkSpeed = DEFAULT_WALKSPEED
        rs.Heartbeat:Wait()
    end
    
    -- JIKA KARAKTER SUDAH MATI, JANGAN LANJUTKAN
    if h_current.Health <= 0 then
        warn("IIGR: Karakter sudah mati. Teleportasi dihentikan.")
        return
    end

    -- 2. SETUP ZERO-LAG TELEPORT (Dilakukan di Heartbeat berikutnya)
    local connection = nil
    
    connection = rs.Heartbeat:Connect(function()
        -- Teleportasi harus dilakukan segera setelah Health = 0 terkirim ke Server
        char:SetPrimaryPartCFrame(tp_pos)
        warn("ZERO-LAG TP Selesai.")
        connection:Disconnect()
    end)
    
    -- 3. KEMATIAN NYATA: Ini akan diproses Server di frame ini
    h_current.Health = 0 
    
    -- Skrip terus berjalan ke GUI dan menunggu Respawn.

    warn("IIGR Final. Item seharusnya sudah aman di Base. Menunggu Respawn...")
    
    -- JANGAN panggil toggle_stealth_mode: Server akan memaksa respawn penuh.
end

-- [ D. IMPLEMENTASI GUI (PERMANEN - V23) ]

local sg = Instance.new("ScreenGui")
sg.Name = ("IIGRHub_V23") 
sg.ResetOnSpawn = false
sg.Parent = p.PlayerGui
sg.Modal = true 

local action_bar = Instance.new("Frame")
action_bar.Name = "action_bar"
action_bar.Size = UDim2.new(0, 200, 0, 40) 
action_bar.Position = UDim2.new(1, -210, 1, -50) 
action_bar.BackgroundColor3 = Color3.fromRGB(10, 10, 10)
action_bar.BorderColor3 = MAIN_COLOR
action_bar.BorderSizePixel = 1
action_bar.Parent = sg
action_bar.ZIndex = 100 
action_bar.Visible = true 
action_bar.Active = true 
action_bar.Draggable = true 

-- FUNGSI TOMBOL DI ACTION BAR
local function create_bar_button(name, posx_offset, callback)
    local btn = Instance.new("TextButton")
    btn.Name = name:gsub("%s+", ""):lower() .. "_btn" 
    btn.Size = UDim2.new(0, 60, 1, 0)
    btn.Position = UDim2.new(0, posx_offset, 0, 0)
    btn.Text = name
    btn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    btn.TextColor3 = MAIN_COLOR
    btn.BorderSizePixel = 0
    btn.Parent = action_bar
    
    btn.MouseButton1Click:Connect(function()
        warn("DEBUG V23: Tombol '" .. name .. "' diklik.")
        
        if name == "SAVE" or name == "PHYS OFF" or name == "STEALTH ON" then
            callback(btn)
        else
            callback()
        end
    end) 
    
    return btn
end

-- PENEMPATAN TOMBOL
local save_btn = create_bar_button("SAVE", 0, save_tp)
local phys_btn = create_bar_button("PHYS OFF", 70, toggle_stealth_mode)
phys_btn.Name = "phys_btn" 
create_bar_button("GO!", 140, execute_iigr_tp)
